---
title: 基于基础架构提供商创建新主机并启动Kubernetes
---

使用Rancher，您可以基于[主机模板](/docs/cluster-provisioning/rke-clusters/node-pools/#node-templates)来创建主机池。该主机模板定义了用于在基础设施提供商或云服务商中启动主机的参数。

在基础设施提供商托管的主机池上安装Kubernetes的一个好处是，如果某个主机与集群失去连接，Rancher可以自动创建另一个主机加入集群，以确保主机池的数量符合预期。

有哪些可用于创建主机模板的云提供商取决于启用了哪些[主机驱动](/docs/cluster-provisioning/rke-clusters/node-pools/#node-drivers).

本节涵盖以下主题：

- [主机模板](#主机模板)
  - [主机标签](#主机标签)
  - [主机污点](#主机污点)
- [主机池](#主机池)
  - [主机池污点](#主机池污点)
  - [关于自动替换主机](#关于自动替换主机)
  - [开启自动替换主机](#开启自动替换主机)
  - [关闭自动替换主机](#关闭自动替换主机)
- [云凭证](#云凭证)
- [主机驱动](#主机驱动)

## 主机模板

主机模板保存了用于配置指定云提供商中的主机时使用的参数。这些主机可以从UI中启动。Rancher使用[Docker Machine](https://docs.docker.com/machine/)来启动这些主机。具体有哪些可用于创建主机模板的云提供商取决于在Rancher中开启了哪些主机驱动。

在Rancher中创建并保存主机模板后，您可以再次使用该模板来创建主机池。主机模板会绑定到您登录的用户中。您可以在用户个人资料中将创建的主机模板删除。

#### 主机标签

您可以在主机模板中添加[标签](https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/)，这样从该主机模板创建的所有主机都将自动具有这些标签。

#### 主机污点

_从Rancher v2.3.0开始可用_

您可以在主机模板中添加[污点](https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/)，这样从该主机模板创建的所有主机都将自动具有这些污点。

由于可以同时在主机模板和主机池中添加污点，因此如果添加了相同键的污点并且效果没有冲突，则所有污点都将被添加到主机。 如果存在具有相同键但不同效果的污点，则主机池中的污点将覆盖主机模板中的污点。

## 主机池

使用Rancher，您可以基于[主机模板](#node-templates)创建主机池。 使用主机池的好处是，如果主机被破坏或删除，您可以增加活动主机的数量以补偿丢失的主机。 主机池可帮助您确保主机的数量符合预期。

每个主机池都分配有一个[主机组件](/docs/cluster-provisioning/#kubernetes-cluster-node-components)以指定如何为Kubernetes集群配置这些主机。

#### 主机池污点

_从Rancher v2.3.0开始可用_

如果您尚未在主机模板上定义[污点](https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/)，则可以为每个主机池添加污点。 相比在主机模板上添加污点，在主机池上添加污点的好处在于，您可以替换主机模板，而不必担心污点是否在主机模板中。

对于每个污点，它们将自动添加到主机池中创建的主机。 因此，如果您在已有主机的主机池中添加污点，这些污点将不适用于该主机池中的已有的主机，但是该主机池中的任何新主机都将获得该污点。

当主机模板和主机池中同时添加了污点时，如果添加了相同键的污点的效果没有冲突，则所有污点都将被添加到主机。 如果存在具有相同键但不同效果的污点，则主机池中的污点将覆盖主机模板中的污点。

#### 关于主机自动替换

_从Rancher v2.3.0开始可用_

如果主机在主机池中，Rancher能够自动替换不可达的主机。 如果主机在指定的时间中处于非活动状态，Rancher将使用该主机池的主机模板来重新创建主机。

> **重要:** 自我修复主机池旨在帮助您为**无状态**应用程序替换工作主机。 不建议在主主机或具有持久卷连接的主机的主机池上启用主机自动替换。 当主机池中的主机失去与集群的连接时，其持久卷将被破坏，从而导致有状态应用程序丢失数据。

 accordion id="how-does-node-auto-replace-work" label="主机自动替换是如何工作的?" 
主机自动替换在Kubernetes主机控制器之上工作。 主机控制器会定期检查所有主机的状态（可通过`kube-controller`的`--node-monitor-period`参数进行配置）。 当主机不可访问时，主机控制器将为该主机添加污点。 发生这种情况时，Rancher将开始其删除倒计时。 您可以配置Rancher等待删除主机的时间。 如果在删除倒计时结束之前污点没有被移除，Rancher将删除该主机。然后Rancher将根据主机池的设置主机数量来创建新的主机。
 /accordion 
 
#### 开启主机自动替换

创建主机池时，您可以指定Rancher替换无响应主机的等待时间（以分钟为单位）。

1. 在创建集群表单中, 选择**主机池**选项卡.
1. 选择要开启主机自动替换功能的主机池，在**自动替换**列中输入Rancher自动替换主机需要的等待时间。
1. 填写表单中的其他信息并创建集群。

**结果:** 主机池开启了主机自动替换功能。

您还可以通过以下步骤在创建集群后启用主机自动替换功能：

1. 在全局页面中，选择集群列表页。
1. 选择您要开启主机自动替换功能的集群, 点击右侧**菜单**选项，并点击**编辑**按钮。
1. 在**主机池**选项卡中，选择要开启主机自动替换功能的主机池，在**自动替换**列中输入Rancher自动替换主机需要的等待时间。
1. 点击**保存**。

**结果:** 主机池开启了主机自动替换功能。

#### 关闭主机自动替换功能

您可以通过以下步骤在Rancher UI中禁用主机自动替换功能：

1. 在全局页面中，选择集群列表页。
1. 选择您要关闭主机自动替换功能的集群, 点击右侧**菜单**选项，并点击**编辑**按钮。
1. 在**主机池**选项卡中，选择要关闭主机自动替换功能的主机池，在**自动替换**列中输入0。
1. 点击**保存**。

**结果:** 主机池关闭了主机自动替换功能。

## 云凭证

_从Rancher v2.2.0开始可用_

主机模板可以使用云凭证来存储用于在云提供商中启动主机的凭证，这有做有如下好处：

- 凭证会在Kubernetes中保存为secret，这不仅更安全，而且还允许您编辑主机模板，而不必每次都输入凭证。

- 云凭证创建后, 您可以在创建其他主机模板时重复使用该凭证。

- 多个主机模板可以共享相同的云凭据来创建主机池。 如果您的密钥已被盗用或过期，您可以在一个位置更新云凭证，从而可以立即更新所有使用它的主机模板。

> **注意：** 从v2.2.0开始，默认的`活动`的[主机驱动程序](/docs/admin-settings/drivers/node-drivers/)和其他主机驱动程序中，标记为`密码`的字段都要求使用云凭证。 如果您是升级到v2.2.0版本，已有的主机模板将继续使用以前的帐户访问信息，但是在编辑该主机模板时，您需要创建云凭证并且该主机模板将开始使用它。

创建云凭证后，用户可以开始[管理他们创建的云凭证](/docs/user-settings/cloud-credentials/)。

## 主机驱动程序

如果您找不到想要使用的主机驱动程序，您可以在Rancher的[内置主机驱动程序](/docs/admin-settings/drivers/node-drivers/#activating-deactivating-node-drivers)中查看它是否可用并激活它，或者您可以[添加自定义主机驱动程序](/docs/admin-settings/drivers/node-drivers/#adding-custom-node-drivers)。
